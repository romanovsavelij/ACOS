\section{Unix системы}

\subsection{Компоненты операционной системы}

\begin{Def}
	\underline{Ядро} --- программа, которая запускается самой первой. Имеет привилегированное положение на процессоре и может взаимодействовать с <<железом>> напрямую.
\end{Def}

\begin{Def}
	\underline{Базовые библиотеки}: зачастую входят в состав операционной системы, потому что привязаны к определенному ядру (версии ядра), чтобы максимально использовать его функциональность. 
\end{Def}

\begin{Def}
\underline{Служебные сервисы} --- ведение логов, обработка сетевых соединения, и т.д.
\end{Def}

\begin{Def}
\underline{Минимальная пользовательская оболочка} --- чтобы пользователь мог взаимодействовать с системой.
\end{Def}

\subsection{Процессы}

\begin{Def}
\underline{Процесс} --- любой экземпляр программы, работающей в операционной системе.
\end{Def}

Примеры:
\begin{itemize}
	\item Приложения
	\item Фоновые сервисы (демоны)
	\item Команды в терминале
\end{itemize}

Главные команды для мониторинга процессов:
\begin{itemize}
	\item ps -A -- список процессов
	\item pstree -- иерархия процессов
	\item top
\end{itemize}

\subsection{UNIX программы}

Программы:
\begin{itemize}
	\item \textbf{Бинарные исполняемые файлы.}
	\item \textbf{Текстовый файл, начинающийся с \#!.} После \#! указывается путь к интерпретатору (например, \#!/bin/bash). Это могут быть скрипты на Python/Perl/Escript или Shell скрипт.
\end{itemize}

Название файла и его расширение не имеет значения. Любой файл, имеющий атрибут 
<<исполняемый>> является программой.

\subsection{UNIX пользователи}

Единственные привилегированный пользователь: root (UID = 0).

Непривилегерованные пользователи:
\begin{itemize}
	\item Реальные пользователи, которые могут войти в систему (UID $\ge$ 1000)
	\item Фейковые пользователи, привязанные к сервисам (UID $<$ 1000).
\end{itemize}

\textbf{Зачем нужны сервисам нужны фейковые пользователи?}
Допустим, у вас есть веб-сервер и сервер баз данных. Теоретически какой-то пользователь
может подключиться к веб-серверу и найти там уязвимость. Для того, чтобы 
минимизировать возможный ущерб от уязвимости в одном из процессов, процессы запускаются
под разными пользователями и не имеют права общаться друг с другом.

Непривилегерованные пользователи могут временно получить 
дополнительные привилегии:
\begin{itemize}
	\item su - запускает терминал от имени root
	\item sudo - запускает любую программу от имени root
	\item Запустить программу с атрибутом SUID и владельцем root. SUID атрибут означает, что при запуске программа
	исполняется от того пользователя, кто является владельцем файла. Кстати, так и 
	работает команда sudo, владелец sudo - root, а также у sudo проставлен атрибут SUID.
	\item Запустить программу с <<capabilities>> флагами. Эти флаги позволяют тонко настроить, что можно делать программе, а что - нельзя.
\end{itemize}

\subsection{UNIX Межпроцессорное взаимодействие}

Процессы работают изолированно друг от друга.

Единственный способ взаимодействовать друг с другом - использовать методы межпроцессорного взаимодействия ядра (Inter-process communication, IPC):
\begin{itemize}
	\item \textbf{Сигналы} для коротких сообщений
	\item \textbf{Каналы и сокеты} для последовательных данных
	\item \textbf{Разделяемая память}, в которой хранятся большие куски данных
\end{itemize}

\subsection{Процесс запуска}

\begin{itemize}
	\item \textbf{Загрузчик} с диска или UEFI материнской платы выполняется в привилегированном режиме
	\item Загрузчик запускает \textbf{ядро}, тоже в привилегированном режиме.
	\item Ядро запускает первый непривелигерованный процесс: \textbf{Init или systemd}.
\end{itemize}

\subsection{Сервисы (<<Демоны>>)}

Специальные системные службы, которые работают в фоновом режиме.

Минимальный сет во многих системах:
\begin{itemize}
	\item \textbf{dhclient} - держит активным полученный IP адрес в сети
	\item \textbf{getty} - переключение между графическим/консольным входом в систему
	\item \textbf{sshd} - подключение по ssh
	\item \textbf{ntpd или chronyd} - синхронизация времени
	\item \textbf{syslogd} - системный лог
\end{itemize}

\subsection{\#!/bin/sh}

В терминале вы работаете в интерпретаторе shell. Shell предоставляет возможность выполнять
команды и последовательности команд.

Бывают разные интерпретаторы shell:
\begin{itemize}
	\item FreeBSD: самодостаточный shell program
	\item Основной в Линукс: symlink to \textbf{bash}
	\item Debian: symlink to \textbf{dash}
	\item Alpine: symlink to \textbf{busybox}
	\item MaxOS X: symlink to \textbf{zsh}
\end{itemize}

\subsection{Системный демон (systemd)}

Процесс, который управляет всеми остальными процессами. При этом сам является
обычным процессом.

Systemd пришел на замену INIT-процессу.

Чем systemd лучше?
\begin{itemize}
	\item Устранение интерпретации shell скриптов. 
	\item Запуск сервисов параллельно
\end{itemize}

\subsection{Концепты systemd}

\begin{itemize}
	\item Сервисы
	\item Цели
		\begin{itemize}
			\item Стандартные цели. Например, уровни init в System-V:
				\begin{itemize}
					\item poweroff.target (init 0)
					\item rescue.target (init 1)
					\item multi-user.target (init 3)
					\item graphical.target (init 5)
					\item reboot.target (init 6)
					\item sleep.target и hibertate.target (не присутствуют в System-V)
				\end{itemize}
			\item Специальные цели
		\end{itemize}
\end{itemize}

\subsection{Фоновые задачи}

\begin{itemize}
	\item \textbf{Нет привязанного к задаче терминала.} Для того, чтобы сигнал SIGHUP
	не останавливал исполнение задачи используется команда \textbf{nohup}.
	\item \textbf{Пишут в лог.} Иногда пишут данные в какую-то старинную 
	локальную почтовую систему.
	\item \textbf{Запускается в единственном экземпляре.} Обычно это достигается
	с помощью file lock.
\end{itemize}

\subsection{Дистрибутивы Линукс}

Ядро называется Линукс. Базовая система - минимальная юзабельная система.

Дистрибутив:
\begin{itemize}
	\item Ядро
	\item Базовая система
	\item GUI оболочка
	\item Программное обеспечение 
\end{itemize}

\textbf{Какие есть дистрибутивы?} \\
Общего назначения:
\begin{itemize}
	\item OpenSUSE
	\item Fedora
	\item Debian
	\item Ubuntu
\end{itemize}

Специфические дистрибутивы:
\begin{itemize}
	\item Alpine Linux - очень легковесный, поэтому его
	хорошо ставить на виртуальную машину.
	\item Kali Linux - используется для тестов на безопасность.
\end{itemize}

